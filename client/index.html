<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="google-signin-client_id" content="49448474710-di214n0on4v9c8jutl7kf4j0rj3chm7i.apps.googleusercontent.com">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <link rel="stylesheet" href="css/style.css">
    <title>Register</title>
  </head>
  <body>
    <!-- Login -->
  <div id="form-input-login">
    <h1 class="text-center pt-3 ">Login</h1>
    <div id="alert-error"></div>
    <div id="cont" class="container col-6 pt-4 pb-2 bl-3 text-black fw-bolder">
      <form id="login-form">
        <div class="mb-3 row">
          <label class="col-sm-2 col-form-label">Email</label>
          <div class="col-sm-10">
            <input type="email" class="form-control" id="input-email" placeholder="email">
          </div>
        </div>
        <div class="mb-3 row">
          <label class="col-sm-2 col-form-label">Password</label>
          <div class="col-sm-10">
            <input type="password" class="form-control" id="input-password" placeholder="password">
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Login</button>
      </form>
      <label>Belum punya akun?</label>
      <a id="link-register" href="#">Register</a>
      <!-- login google -->
      <span>
        <div class="g-signin2" data-onsuccess="onSignIn"></div>
      </span>
      <!-- end login google -->
    </div>
  </div>
<!-- End Login -->

    <!-- Register -->
  <div id="form-register">
    <h1 class="text-center pt-3 ">Regsiter</h1>
    <div id="cont" class="container col-6 pt-4 pb-2 bl-3 text-black fw-bolder">
      <form id="form-register-user">
        <div class="mb-3 row">
          <label class="col-sm-2 col-form-label">Username</label>
          <div class="col-sm-10">
            <input type="text" class="form-control" id="register-username" placeholder="username">
          </div>
        </div>
        <div class="mb-3 row">
          <label class="col-sm-2 col-form-label">Email</label>
          <div class="col-sm-10">
            <input type="email" class="form-control" id="register-email" placeholder="email">
          </div>
        </div>
        <div class="mb-3 row">
          <label class="col-sm-2 col-form-label">Password</label>
          <div class="col-sm-10">
            <input type="password" class="form-control" id="register-password" placeholder="password">
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Register</button>
      </form>
      <label>Sudah punya akun?</label>
      <a id="link-login" href="#">Login</a>
    </div>
  </div>
  <!-- End Register -->

  <!-- main -->
  <!-- Navbar -->
<div id="main-content">
  <nav class="navbar navbar-light">
    <div class="container-fluid">
      <h3 class="text-center">Todos</h3>
      <form class="d-flex">
        <a id="nav-logout" href="">Logout</a>
      </form>
    </div>
  </nav>
<!-- End Navbar -->

<!-- Table -->
  <div class="container mt-3 col-7">
    <h1 class="text-center">Comic</h1>
    <a id="id-add-todo" class="btn btn-primary">Add</a>
    <table class="table table-striped" >
      <thead>
        <tr>
          <th>#</th>
          <th>Title</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="table-todos">
      </tbody>
    </table>
  </div>
</div>
<!-- End Table -->

<!-- Add Data -->
<div id="form-add-data">
  <h1 class="text-center pt-3 ">Add Todo</h1>
  <div id="cont" class="container col-6 pt-4 pb-2 bl-3 text-black fw-bolder">
    <form id="form-add-data">
      <div class="mb-3 row">
        <label class="col-sm-2 col-form-label">Title</label>
        <div class="col-sm-10">
          <input type="text" class="form-control" id="add-title" placeholder="username">
        </div>
      </div>
      <div class="mb-3 row">
        <label class="col-sm-2 col-form-label">Description</label>
        <div class="col-sm-10">
          <textarea id="add-description" cols="49" rows="5"></textarea>
        </div>
      </div>
      <div class="mb-3 row">
        <label class="col-sm-2 col-form-label">Date</label>
        <div class="col-sm-10">
          <input type="date" class="form-control" id="add-date">
        </div>
      </div>
      <button type="submit" class="btn btn-primary">Add</button>
      <a id="back" class="btn btn-danger">Back</a>
    </form>
  </div>
</div>
<!-- End Add Data -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="https://apis.google.com/js/platform.js" async defer></script>
  <script>
    const base_URL = "http://localhost:3000/"
    function auth(){
      if(!localStorage.getItem("access_token")){
        $("#form-input-login").show()
        $("#form-register").hide()
        $("#main-content").hide()
        $("#form-add-data").hide()
      }else{
        $("#form-input-login").hide()
        $("#form-register").hide()
        $("#form-add-data").hide()
        $("#main-content").show()
        todos()
      }
    }

    function login(){
      let email = $("#input-email").val()
      let password = $("#input-password").val()
      $.ajax({
        url: `${base_URL}users/login`,
        method: "POST",
        data: {email,password}
      })
        .done(res => {
          localStorage.setItem("access_token", res.access_token)
          auth()
        })
        .fail((xhr, text) => {
          $("#alert-error").empty()
          $("#alert-error").prepend(`
          <p style="color: red; text-align: center;">${xhr.responseJSON.message}</p>
          `)
        })
        .always(_ => {
          $("#login-form").trigger("reset")
        })
    }

    function onSignIn(googleUser) {

      var id_token = googleUser.getAuthResponse().id_token;
      // console.log(id_token);
      $.ajax({
        url: base_URL+"users/googleLogin",
        method: "POST",
        data: {
          googleToken: id_token
        }
      })
        .done(respone => {
          localStorage.setItem("access_token", respone.access_token)
          auth()
        })
        .fail((err) => {
          // console.log(xml, 'xml jquery -------------');
          console.log(err, 'err jquery -------------');
        })
    }
    
    function register(){
      $("#form-input-login").hide()
      $("#form-register").show()
      $("#main-content").hide()
      $("#form-add-data").hide()
    }

    function addTodo(){
      $("#form-input-login").hide()
      $("#form-register").hide()
      $("#main-content").hide()
      $("#form-add-data").show()
    }

    function todos(){
      $.ajax({
        url: base_URL+"todos",
        method: "GET",
        headers:{
          token: localStorage.getItem("access_token")
        }
      })
        .done(todo => {
          $("#table-todos").empty()
          todo.forEach((el,i) => {
            $("#table-todos").append(`
            <tr>
              <th>${i+1}</th>
              <td>${el.title}</td>
              <td>${el.status}</td>
              <td>
                <a href="" class="btn btn-success">Show</a>
                <a href="" class="btn btn-warning">Edit</a>
                <a href="" class="btn btn-danger">Delete</a>
              </td>
            </tr>
            `)
          })
        })
        .fail((xml,err) =>{
          console.log(xml,err);
        })
    }

    function logout(){
      localStorage.clear()
      var auth2 = gapi.auth2.getAuthInstance();
      auth2.signOut().then(function () {
        console.log('User signed out.');
      });
      auth()
    }

    function createUser(){
      let username = $("#register-username").val()
      let email = $("#register-email").val()
      let password = $("#register-password").val()
      console.log(username, email, password);
      $.ajax({
        url: base_URL+"users/register",
        method: "POST",
        data: {username,email,password}
      })
        .done(user => {
          auth()
        })
        .fail((xml, err) => {
          console.log(xml);
          console.log(err);
        })
        .always(_ => {
          $("#form-register-user").trigger("reset")
        })
    }

    $(document).ready(() => {
      auth()
      $("#link-login").on("click", (e) =>{
        e.preventDefault()
        auth()
      })
      $("#link-register").on("click", (e) =>{
        e.preventDefault()
        register()
      })

      $("#login-form").on("submit", (e) =>{
        e.preventDefault()
        login()
      })

      $("#nav-logout").on("click", (e) => {
        e.preventDefault()
        logout()
      })

      $("#form-register-user").on("submit", (e) =>{
        e.preventDefault()
        createUser()
      })

      $("#id-add-todo").on("click", (e) => {
        e.preventDefault()
        addTodo()
      })

      $("#back").on("click", (e) => {
        e.preventDefault()
        auth()
      })
    })

  </script>  

</body>
</html>